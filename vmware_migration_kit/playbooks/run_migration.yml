---
- name: Deploy conversion host
  hosts: migrator
  tasks:
  - name: Make sure conversion hosts are cleaned up
    ansible.builtin.import_playbook:
      "vmware_migration_kit/playbooks/delete_os_conversion_host.yml"
    when: deploy_conversion_host|default(false)|bool

  - name: Deploy conversion hosts
    ansible.builtin.import_playbook:
      "vmware_migration_kit/playbooks/deploy_conversion_hosts.yml"
    when: deploy_conversion_host|default(false)|bool

- name: Make sure conversion host is correctly configured
  hosts: conversion_host
  tasks:
    - name: Install the conversion host content
      become: true
      ansible.builtin.import_tasks: "vmware_migration_kit/playbooks/conversion_host_content.yml"
      when: already_deploy_conversion_host|default(false)|bool

# Gather information from vmware (networks and flavors)
- name: Export vmware metadata
  hosts: migrator
  tasks:
    - name: Export vmware metadata
      ansible.builtin.include_role:
        name: os_migrate.vmware_migration_kit.export_metadata

# Map metadata to create destination flavor
# TODO

# Migrate vmware vms to cinder volumes
# Create instances in openstack from cinder volumes and vmware metadata
- name: Migrate vmware virtual machines
  hosts: conversion_host
  become: true
  tasks:
    - name: Migrate vmware virtual machines
      ansible.builtin.include_role:
        name: os_migrate.vmware_migration_kit.import_workloads

# Cleanup